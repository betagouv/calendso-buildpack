#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Debug, echo every command
if [[ -n "$BUILDPACK_DEBUG" ]]; then
  set -x
fi

# Fail immediately on non-zero exit code.
set -e
# Fail immediately on non-zero exit code within a pipeline.
set -o pipefail
# Fail on undeclared variables.
set -u

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

CALENDSO_VERSION=$(cat "$ENV_DIR/CALENDSO_VERSION")

echo "Downloading Calendso ${CALENDSO_VERSION}..."

archive_url="https://github.com/calcom/cal.com/archive/refs/tags/v${CALENDSO_VERSION}.tar.gz"
curl -L -O --output-dir $CACHE_DIR -C - "${archive_url}"

echo "Extracting the Calendso release..."

tar xzf "$CACHE_DIR/v${CALENDSO_VERSION}.tar.gz" -C $BUILD_DIR --strip-components=1

echo "Done. Letting the NodeJS buildpack take over."
